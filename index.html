<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DZ3110PTYG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-DZ3110PTYG');

        // ğŸ”½ è‡ªåŠ¨è·å–å¹¶ä¸ŠæŠ¥ utm_content å‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const utmContent = urlParams.get('utm_content');
        if (utmContent) {
            gtag('event', 'utm_content_event', {
                utm_content: utmContent
            });
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HACOO SpreadSheet</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="global-search.css">    
    <link rel="stylesheet" href="product-detail-modal.css">
    
    <script src="config.js"></script>

    <script>
        // 1. ç«‹å³æ‰§è¡Œï¼šæ•è· URL ä¸­çš„æ¥æºå‚æ•° (?s=xxx)
        (function() {
            try {
                const p = new URLSearchParams(window.location.search);
                // æ”¯æŒ s, source, utm_source
                const s = p.get('s') || p.get('source') || p.get('utm_source');
                if (s) {
                    // åŒé‡å­˜å‚¨ï¼Œç¡®ä¿ä¸ä¸¢å¤±
                    localStorage.setItem('traffic_source', s);
                    sessionStorage.setItem('traffic_source', s);
                    console.log('%câœ… [Analytics] Source Captured: ' + s, 'color:green;font-weight:bold;');
                }
            } catch(e) { console.error('Source capture error', e); }
        })();

        // 2. å®šä¹‰å…¨å±€ä¸ŠæŠ¥å‡½æ•° (ä¾›é¡µé¢å„å¤„è°ƒç”¨)
        window.reportEvent = function(eventName, params = {}) {
            // ç¡®ä¿ CONFIG å·²åŠ è½½
            if (typeof CONFIG === 'undefined' || !CONFIG.ANALYTICS) {
                console.warn('CONFIG not loaded yet');
                return;
            }

            // ç›´æ¥å¤ç”¨ product-detail.js ä¸­çš„ reportEvent é€»è¾‘ï¼ˆå¦‚æœå·²åŠ è½½ï¼‰
            // æˆ–è€…åœ¨è¿™é‡Œå®ç°ç›¸åŒçš„é€»è¾‘ï¼Œç¡®ä¿ source å­—æ®µå­˜åœ¨
            // è·å–æ¥æº (ä¼˜å…ˆ Session -> Local -> Default)
            const trafficSource = sessionStorage.getItem('traffic_source') || localStorage.getItem('traffic_source') || 'direct';
            
            // æ„å»ºæ•°æ®åŒ… - Cloudflare Worker
            const cfPayload = {
                site_id: CONFIG.ANALYTICS.SITE_ID, // ä» config.js è¯»å– 'hacoo'
                event: eventName,
                source: trafficSource,             // [å…³é”®] æ¥æºæ¸ é“
                ts: Date.now(),
                cid: (localStorage.getItem('__cid') || (Date.now() + '-' + Math.random())),
                page: location.pathname,
                ref: document.referrer || '',
                ua: navigator.userAgent,
                ...params
            };

            // å‘é€ç»™ Cloudflare Worker (ä½¿ç”¨ sendBeacon æˆ– fetch)
            const endpoint = CONFIG.ANALYTICS.CF_ENDPOINT;
            const json = JSON.stringify(cfPayload);
            const blob = new Blob([json], { type: 'text/plain' });
            
            if (navigator.sendBeacon) {
                navigator.sendBeacon(endpoint, blob);
            } else {
                fetch(endpoint, {
                    method: 'POST',
                    keepalive: true,
                    headers: { 'Content-Type': 'text/plain' },
                    body: json
                }).catch(e => console.error('Analytics Report Error:', e));
            }

            // åŒæ—¶å‘é€ç»™ Google Analytics (ä¿æŒåŸæœ‰é€»è¾‘)
            if (typeof gtag === 'function') {
                gtag('event', eventName, params);
            }
        };
    </script>
    
    <script src="product-service.js"></script>
    <script src="product-renderer.js"></script>
    <script src="trust-info.js"></script>
    <script src="product-trust-info.js"></script>
    <script src="product-detail.js"></script>
    <script src="global-search.js"></script>
</head>
<body>
    <div class="top-info-bar" id="trust-bar"> 
        <i class="fas fa-shield-alt"></i> 
        This page displays products only. Orders are securely processed via <strong style="color:#00784E; font-weight:600;">HACOO Platform</strong> with buyer protection & after-sales support.
    </div>
    

    
    <header>
        <div class="header-top">
            <a href="#" class="logo" onclick="SPA.navigateToCategory(CONFIG.SITE.DEFAULT_CATEGORY)">HACOO SpreadSheet</a>
            <div class="nav-links" id="header-nav">
                </div>
        </div>
        <div class="header-bottom">
            <div class="search-container">
                <input type="text" class="search-box" placeholder="Search products...">
                <span class="search-icon"><i class="fas fa-search"></i></span>
            </div>
        </div>
    </header>

    <div id="payment-methods" style="text-align: center; margin: 12px 0 18px;">
        <div style="font-size: 13px; color: #555; margin-bottom: 6px;"><strong>Secure payments</strong> supported by</div>
        <div style="display: inline-flex; align-items: center; gap: 12px;" id="payment-icons">
            </div>
    </div>
    <div class="responsive-banner" style="max-width: 1200px; margin: 12px auto;">
        <a href="https://cnfans.center/" target="_blank" rel="noopener noreferrer" style="display:block; text-decoration:none;" onclick="try{reportEvent('banner_click',{platform:'FFbuy',href:this.href,page:location.pathname});}catch(e){}">
            <picture>
                <source media="(max-width: 768px)" srcset="img/Mobile.png">
                <img src="img/PC.png" alt="Banner" style="width: 100%; height: auto;">
            </picture>
        </a>
    </div>

    <nav id="main-nav">
        </nav>

    <div class="container">
        <div class="promo-modal" id="promoModal" aria-hidden="true">
            <div class="promo-modal-content">
                <button class="promo-modal-close" id="closePromoModal" aria-label="Close">&times;</button>
                <div class="promo-figure">
                    <a class="promo-link" href="https://chat.whatsapp.com/EcWmZtsM9eQ2Lf40C3ubf4" target="_blank" rel="noopener noreferrer" onclick="try{reportEvent('banner_click',{platform:'whatsapp',href:this.href,page:location.pathname});}catch(e){}">
                        <img src="img/Banner_1.webp" alt="Join WhatsApp Group" class="promo-modal-img">
                    </a>
                    <div class="promo-overlay">
                        <a class="promo-join-btn" href="https://chat.whatsapp.com/EcWmZtsM9eQ2Lf40C3ubf4" target="_blank" rel="noopener noreferrer" onclick="try{reportEvent('banner_click',{platform:'whatsapp',href:this.href,page:location.pathname});}catch(e){}">Ãšnete ahora</a>
                        <button type="button" class="promo-close-btn">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="loading-indicator" style="display: none; text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #666;"></i>
            <p style="margin-top: 10px; color: #666;">Loading products...</p>
        </div>
        
        <div id="error-indicator" style="display: none; text-align: center; padding: 40px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #e74c3c;"></i>
            <p style="margin-top: 10px; color: #e74c3c;" id="error-message">Failed to load products</p>
            <button onclick="SPA.retryLoadCategory()" style="margin-top: 15px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
        </div>
        
        

        <div class="products-grid" id="products-container">
             </div>
    </div>

    <div class="floating-buttons" id="floatingButtons">
        <div class="float-btn toggle-btn" id="toggleFloatingBtn"><i class="fas fa-headset"></i></div>
        <div class="floating-content" id="floatingContent">
            <img src="img/query.png" alt="Trust Guarantee" class="trust-icon" id="trustBtn">
            <img src="img/telegram.png" alt="Telegram" class="telegram-icon">
            <img src="img/ws.png" alt="WhatsApp" class="whatsapp-icon">
        </div>
    </div>
    <div class="float-btn back-to-top"><i class="fas fa-arrow-up"></i></div>

    <div class="product-detail-modal" id="productDetailModal">
        <div class="product-detail-content">
            <div class="product-detail-header">
                <h2 class="product-detail-title">Product Details</h2>
                <button class="product-detail-close" id="closeDetailModal">&times;</button>
            </div>
            <div class="product-detail-body" id="productDetailBody">
                <div class="product-detail-loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading product details...
                </div>
            </div>
        </div>
    </div>

    <script>
        // SPAåº”ç”¨æ ¸å¿ƒ
         const SPA = {
             currentCategory: null,
             isLoading: false,
            
            // åˆå§‹åŒ–åº”ç”¨
            init() {
                this.generateNavigation();
                this.generatePaymentMethods();
                this.setupEventListeners();
                this.handleInitialRoute();
            },
            
            // å¤„ç†åˆå§‹è·¯ç”±
             handleInitialRoute() {
                const urlParams = new URLSearchParams(window.location.search);
                const category = urlParams.get('category') || CONFIG.SITE.DEFAULT_CATEGORY;
                this.navigateToCategory(category, false);
                const cObj = CONFIG.UTILS.getCategoryByName(category);
                if (cObj) {
                    const currPath = window.location.pathname + window.location.search;
                    const pv = { page_title: `${cObj.displayName} - ${CONFIG.SITE.NAME}`, page_path: currPath, page_location: window.location.href };
                    
                    // è¿™é‡Œä¼šè‡ªåŠ¨è°ƒç”¨ head ä¸­å®šä¹‰çš„å…¨å±€ reportEvent
                    if (typeof window.reportEvent === 'function') {
                        window.reportEvent('page_view', pv);
                    }
                }
             },
            
            // ç”Ÿæˆå¯¼èˆªèœå•
            generateNavigation() {
                const headerNav = document.getElementById('header-nav');
                const mainNav = document.getElementById('main-nav');
                
                const navHTML = CONFIG.categories.map(category => {
                    return `<a href="#" onclick="SPA.navigateToCategory('${category.name}')" data-category="${category.name}">
                        <i class="${category.icon}"></i> ${category.displayName}
                    </a>`;
                }).join('\n');
                
                if (headerNav) headerNav.innerHTML = navHTML;
                if (mainNav) mainNav.innerHTML = navHTML;
            },
            
            // ç”Ÿæˆæ”¯ä»˜æ–¹å¼
            generatePaymentMethods() {
                const paymentIcons = document.getElementById('payment-icons');
                if (paymentIcons && CONFIG.PAYMENT_METHODS) {
                    paymentIcons.innerHTML = CONFIG.PAYMENT_METHODS.map(method => 
                        `<img src="${method.logo}" alt="${method.alt}" height="24" style="padding: 0 4px; vertical-align: middle;">`
                    ).join('\n');
                }
            },
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
             setupEventListeners() {
                 // æµè§ˆå™¨å‰è¿›åé€€
                 window.addEventListener('popstate', (event) => {
                     if (event.state && event.state.category) {
                         this.navigateToCategory(event.state.category, false);
                     } else {
                         this.handleInitialRoute();
                     }
                 });
             },
            
            // å¯¼èˆªåˆ°åˆ†ç±»
            navigateToCategory(categoryName, updateHistory = true) {
                if (this.isLoading) {
                    // å–æ¶ˆå½“å‰åŠ è½½ï¼Œå…è®¸å¿«é€Ÿåˆ‡æ¢åˆ†ç±»
                    if (typeof productRenderer !== 'undefined' && typeof productRenderer.cancelLoad === 'function') {
                        productRenderer.cancelLoad();
                    }
                }
                
                const category = CONFIG.UTILS.getCategoryByName(categoryName);
                if (!category) {
                    console.error('Category not found:', categoryName);
                    return;
                }
                
                if (updateHistory) {
                    if (typeof window.reportEvent === 'function') {
                        window.reportEvent('category_click', { category_name: category.name, category_display: category.displayName });
                    }
                }

                this.currentCategory = categoryName;
                
                // æ›´æ–°URLå’Œå†å²è®°å½•
                if (updateHistory) {
                    const newUrl = `${window.location.pathname}?category=${encodeURIComponent(categoryName)}`;
                    history.pushState({ category: categoryName }, '', newUrl);
                    var pv = { page_title: `${category.displayName} - ${CONFIG.SITE.NAME}`, page_path: newUrl, page_location: window.location.origin + newUrl };
                    
                    if (typeof window.reportEvent === 'function') {
                        window.reportEvent('page_view', pv);
                    }
                }
                
                // æ›´æ–°é¡µé¢æ ‡é¢˜
                document.title = `${category.displayName} - ${CONFIG.SITE.NAME}`;
                
                // æ›´æ–°å¯¼èˆªçŠ¶æ€
                this.updateNavigationState(categoryName);

                // æ¸…ç†ä»»ä½•ä¿ç•™çš„â€œè¿”å›å½“å‰åˆ†ç±»â€æŒ‰é’®
                const backBtn = document.getElementById('back-to-results-btn');
                if (backBtn) backBtn.remove();
                
                // åŠ è½½äº§å“
                this.loadCategoryProducts(category);
            },
            
            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            updateNavigationState(activeCategory) {
                document.querySelectorAll('nav a, .nav-links a').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.category === activeCategory) {
                        link.classList.add('active');
                    }
                });
            },
            
            // åŠ è½½åˆ†ç±»äº§å“
             async loadCategoryProducts(category) {
                 this.showLoading();
                 
                 try {
                     // ä½¿ç”¨ç°æœ‰çš„productRendereræ¥åŠ è½½å’Œæ¸²æŸ“äº§å“
                     if (!productRenderer.init('products-container')) {
                         throw new Error('Failed to initialize product renderer');
                     }
                     
                     await productRenderer.loadProducts(category.endpoint);
                     this.hideLoading();
                     
                 } catch (error) {
                     console.error('Error loading products:', error);
                     this.showError('Failed to load products. Please try again.');
                 }
             },
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading() {
                this.isLoading = true;
                document.getElementById('loading-indicator').style.display = 'block';
                document.getElementById('error-indicator').style.display = 'none';
                document.getElementById('products-container').style.display = 'none';
            },
            
            // éšè—åŠ è½½çŠ¶æ€
            hideLoading() {
                this.isLoading = false;
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('products-container').style.display = 'grid';
            },
            
            // æ˜¾ç¤ºé”™è¯¯
            showError(message) {
                this.isLoading = false;
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('products-container').style.display = 'none';
                document.getElementById('error-indicator').style.display = 'block';
                document.getElementById('error-message').textContent = message;
            },
            
            // é‡è¯•åŠ è½½
            retryLoadCategory() {
                if (this.currentCategory) {
                    const category = CONFIG.UTILS.getCategoryByName(this.currentCategory);
                    if (category) {
                        this.loadCategoryProducts(category);
                    }
                }
            }
        };
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–SPA
        document.addEventListener('DOMContentLoaded', () => {
            SPA.init();
            // æ‰“å¼€é¦–é¡µå¼¹çª— Banner
            try {
                const modal = document.getElementById('promoModal');
                const closeBtn = document.getElementById('closePromoModal');
                if (modal) {
                    modal.classList.add('open');
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            try { reportEvent('banner_close', { reason: 'mask', page: location.pathname }); } catch (err) {}
                            modal.classList.remove('open');
                        }
                    });
                }
                if (closeBtn) closeBtn.addEventListener('click', () => {
                    try { reportEvent('banner_close', { reason: 'top_close', page: location.pathname }); } catch (err) {}
                    const m = document.getElementById('promoModal');
                    if (m) m.classList.remove('open');
                });
                document.querySelectorAll('.promo-close-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        try { reportEvent('banner_close', { reason: 'button', page: location.pathname }); } catch (err) {}
                        const m = document.getElementById('promoModal');
                        if (m) m.classList.remove('open');
                    });
                });
            } catch (e) {}
        });
        
        // å…¨å±€æš´éœ²SPAå¯¹è±¡
         window.SPA = SPA;
     </script>
     
     <script src="floating-buttons.js"></script>
</body>
</html>